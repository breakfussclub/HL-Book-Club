// utils/analytics.js â€” Phase 8 Modernized
// âœ… Provides appendReadingLog, getUserLogs, calcBookStats
// âœ… Works with new storage.js JSON structure
// âœ… Adds DEBUG logging for Railway
// âœ… Handles missing files gracefully

import { loadJSON, saveJSON, FILES } from "./storage.js";

const DEBUG = process.env.DEBUG === "true";

// ---------------------------------------------------------------------------
// Helper: Format Date
// ---------------------------------------------------------------------------

function shortDate(iso) {
  return new Date(iso).toLocaleDateString("en-US", {
    month: "short",
    day: "numeric",
  });
}

// ---------------------------------------------------------------------------
// ğŸ“˜ appendReadingLog
// ---------------------------------------------------------------------------
// Adds a new log entry when user updates progress.
// Structure: logs[userId] = [ { bookId, page, at } ]

export async function appendReadingLog(userId, bookTitle, page) {
  try {
    const logs = await loadJSON(FILES.READING_LOGS);
    if (!logs[userId]) logs[userId] = [];

    logs[userId].push({
      bookId: bookTitle,
      page,
      at: new Date().toISOString(),
    });

    // Keep logs tidy
    if (logs[userId].length > 2000) logs[userId] = logs[userId].slice(-2000);

    await saveJSON(FILES.READING_LOGS, logs);
    if (DEBUG)
      console.log(`[analytics.appendReadingLog] ${userId} â†’ ${bookTitle} (${page})`);
  } catch (err) {
    console.error("[analytics.appendReadingLog]", err);
  }
}

// ---------------------------------------------------------------------------
// ğŸ“— getUserLogs
// ---------------------------------------------------------------------------
// Returns a userâ€™s logs, optionally filtered by book title

export async function getUserLogs(userId, bookTitle = null) {
  try {
    const logs = await loadJSON(FILES.READING_LOGS);
    const arr = logs[userId] || [];
    if (bookTitle)
      return arr.filter((l) =>
        l.bookId.toLowerCase().includes(bookTitle.toLowerCase())
      );
    return arr;
  } catch (err) {
    console.error("[analytics.getUserLogs]", err);
    return [];
  }
}

// ---------------------------------------------------------------------------
// ğŸ“™ calcBookStats
// ---------------------------------------------------------------------------
// Calculates progress percentage and simple stats for embed display

export function calcBookStats(entry) {
  if (!entry?.totalPages) return "";
  const pct = Math.min(
    100,
    Math.round((entry.currentPage / entry.totalPages) * 100)
  );
  const start = entry.startedAt ? shortDate(entry.startedAt) : "â€”";
  const last = entry.updatedAt ? shortDate(entry.updatedAt) : "â€”";

  let msg = `Progress: **${pct}%**`;
  if (entry.currentPage >= entry.totalPages)
    msg += ` âœ… Completed on ${last}`;
  else msg += ` (started ${start}, updated ${last})`;

  return msg;
}
